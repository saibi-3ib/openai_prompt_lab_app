<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investor Post Collector</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-gray-800 shadow-md">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">Investor Post Collector</h1>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-400">Worker Provider: <span class="font-bold text-yellow-400">{{ current_provider }}</span></span>
                <a href="/manage" class="text-blue-400 hover:text-blue-300 transition duration-200">âš™ï¸ è¨­å®šç®¡ç†ã¸</a>
            </div>
        </nav>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="container mx-auto px-6 py-8">
        
        <h2 class="text-xl font-semibold mb-6">æœ€æ–°ã®åé›†ãƒ‡ãƒ¼ã‚¿</h2>

        <!-- ãƒã‚¹ãƒˆã®ãƒªã‚¹ãƒˆ -->
        <div class="space-y-6">
            
            {% for post in posts %}
            <div id="post-{{ post.id }}" class="bg-gray-800 rounded-lg shadow-xl p-6 border border-gray-700 hover:bg-gray-700 transition duration-300">
                
                <!-- æŠ•ç¨¿ãƒ˜ãƒƒãƒ€ãƒ¼ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨æŠ•ç¨¿æ—¥æ™‚ -->
                <div class="flex justify-between items-center mb-4">
                    <p class="font-bold text-lg text-blue-400">{{ post.username }}</p>
                    <span class="text-sm text-gray-400">{{ post.posted_at.strftime('%Y-%m-%d %H:%M') if post.posted_at else 'N/A' }} (UTC)</span>
                </div>

                <!-- AIè¦ç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="mb-4">
                    <p class="font-semibold text-gray-100 mb-2">AIè¦ç´„:</p>
                    <div id="summary-content-{{ post.id }}">
                        {% if post.ai_summary %}
                            <!-- åˆ†æå®Œäº† -->
                            <p class="text-gray-300 bg-green-900/30 p-3 rounded border border-green-700/50">{{ post.ai_summary }}</p>
                        {% else %}
                            <!-- æœªåˆ†æ / ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                            <button onclick="analyzePost('{{ post.id }}')" 
                                    class="analyze-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition duration-200"
                                    data-post-id="{{ post.id }}">
                                ğŸ¤– AIåˆ†æã‚’å®Ÿè¡Œ (ç´„10ç§’)
                            </button>
                        {% endif %}
                    </div>
                </div>

                <!-- å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ -->
                <div class="mb-4 p-3 bg-gray-900 rounded">
                    <p class="text-sm text-gray-400 italic">"{{ post.original_text }}"</p>
                </div>

                <!-- æŠ•ç¨¿ãƒ•ãƒƒã‚¿ãƒ¼ï¼šã„ã„ã­ã€RTã€ã‚½ãƒ¼ã‚¹ã¸ã®ãƒªãƒ³ã‚¯ -->
                <div class="flex justify-between items-center text-sm text-gray-400">
                    <div class="flex space-x-4">
                        <span>â¤ï¸ ã„ã„ã­: {{ post.like_count }}</span>
                        <span>ğŸ” RT: {{ post.retweet_count }}</span>
                        {% if post.link_summary %}
                            <span class="text-yellow-500">ğŸ”— ãƒªãƒ³ã‚¯åˆ†ææ¸ˆ</span>
                        {% endif %}
                    </div>
                    <a href="{{ post.source_url }}" target="_blank" class="text-blue-400 hover:underline">å…ƒã®æŠ•ç¨¿ã‚’è¦‹ã‚‹ &rarr;</a>
                </div>
            </div>
            {% endfor %}
            <!-- â–²â–²â–² ãƒ«ãƒ¼ãƒ—ã“ã“ã¾ã§ â–²â–²â–² -->

        </div>

    </main>

    <!-- JavaScript for API Calls -->
    <script>
        // ãƒã‚¹ãƒˆIDã‚’å—ã‘å–ã‚Šã€AIåˆ†æAPIã‚’å‘¼ã³å‡ºã™é–¢æ•°
        async function analyzePost(postId) {
            const button = document.querySelector(`.analyze-btn[data-post-id="${postId}"]`);
            const summaryContainer = document.getElementById(`summary-content-${postId}`);
            
            // ãƒœã‚¿ãƒ³ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'â±ï¸ åˆ†æä¸­... (ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„)';
            button.classList.remove('bg-indigo-600');
            button.classList.add('bg-yellow-600');

            try {
                // Flaskã®analyzeãƒ«ãƒ¼ãƒˆã«POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
                const response = await fetch(`/analyze/${postId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    // æˆåŠŸã—ãŸå ´åˆ
                    summaryContainer.innerHTML = `
                        <p class="text-gray-300 bg-green-900/30 p-3 rounded border border-green-700/50">
                            ${result.summary}
                        </p>
                    `;
                } else {
                    // å¤±æ•—ã—ãŸå ´åˆ
                    alert('åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.message); // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    summaryContainer.innerHTML = `
                        <p class="text-red-400 bg-red-900/30 p-3 rounded border border-red-700/50">
                            åˆ†æå¤±æ•—: ${result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}
                        </p>
                    `;
                }

            } catch (error) {
                // é€šä¿¡è‡ªä½“ãŒå¤±æ•—ã—ãŸå ´åˆ
                console.error('Fetch error:', error);
                summaryContainer.innerHTML = `
                    <p class="text-red-400 bg-red-900/30 p-3 rounded border border-red-700/50">
                        é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                    </p>
                `;
            }
        }
    </script>
</body>
</html>